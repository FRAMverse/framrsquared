<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>sensitivity_analyses • framrsquared</title>
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="sensitivity_analyses">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">framrsquared</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.7.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/framrsquared.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/auditing_tools.html">auditing_tools</a></li>
    <li><a class="dropdown-item" href="../articles/sensitivity_analyses.html">sensitivity_analyses</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/FRAMverse/framrsquared/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>sensitivity_analyses</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/FRAMverse/framrsquared/blob/main/vignettes/sensitivity_analyses.Rmd" class="external-link"><code>vignettes/sensitivity_analyses.Rmd</code></a></small>
      <div class="d-none name"><code>sensitivity_analyses.Rmd</code></div>
    </div>

    
    
<p>We recently developed a fork for FRAM that allows batch running of
FRAM runs (<a href="https://github.com/FRAMverse/FRAM_automation" class="external-link uri">https://github.com/FRAMverse/FRAM_automation</a>). This can
facilitate sensitivity analyses, where we explore the consequences to
fishery mortalities or ERs of changes in some key input or inputs of
interest. Here we provide a tutorial for recently added functionality to
<code>framrsquared</code> that can be used to generate runs for
sensitivity analyses which can then be batch-run in this new FRAM
fork.</p>
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>I begin by describing the fundamental framework underlying the
sensitivity anlaysis functions, then walk through those functions
themselves, and end with an example of using these functions to run a
sensitivity analysis on Elwha for our new OOB work.</p>
</div>
<div class="section level2">
<h2 id="philosophy-and-functions">Philosophy and functions<a class="anchor" aria-label="anchor" href="#philosophy-and-functions"></a>
</h2>
<div class="section level3">
<h3 id="matchreplace-dataframe-approach">Match/Replace dataframe approach<a class="anchor" aria-label="anchor" href="#matchreplace-dataframe-approach"></a>
</h3>
<p>Fundamentally, any sort of changes to the FRAM database – including
for a sensitivity analyses – need to identify</p>
<ol style="list-style-type: decimal">
<li>What should be changed, and</li>
<li>What new values should be used</li>
</ol>
<ol style="list-style-type: decimal">
<li>requires both identify the table (e.g. maybe the StockRecruit
table), the columns to change (e.g., maybe RecruitScaleFactor), and rows
to change (maybe all rows with StockID 17 or 18, or all rows with Age 2,
or some mixing and maxing of conditions).</li>
</ol>
<p>The philosophy I took in writing the <code><a href="../reference/modify_table.html">modify_table()</a></code> and
<code>sensitivity_*()</code> functions was to identify both (1) and (2)
in a systematic, flexible way. All sensitivity analyses functions rely
on <code><a href="../reference/modify_table.html">modify_table()</a></code> under the hood; even though it is
unlikely that we will use <code><a href="../reference/modify_table.html">modify_table()</a></code> directly, it is
important to understand the structure of its input.
<code><a href="../reference/modify_table.html">modify_table()</a></code> answers both (1) and (2) above using a
“match/replace” dataframe. Each column name must start with a prefix of
“match_” or “replace_”, and the rest of the column name should be the
name of a column in the FRAM database column (with exact match of
capitalization). Any column label that starts with “match_” will be used
to identify rows to change, and any column label that starts with
“replace_” provides values that should be used. This is somewhat
analogous to a <code>join()</code> framework, in that we have “match by”
columns (in a join, we would use these for the <code>by =</code>
argument), and other columns that are not used for match. The primary
difference from a join framework is that rather than adding new columns
to a dataframe, we are replacing values in place.</p>
<p>As an example, if we were asked to look at the consequences of
changing the size limits for fishery</p>
<p>For example, if we wanted to change the size limits for Chinook in
Area 7 sport (Fishery ID 36). Currently those are 520 for each time
step, but let’s imagine the request was to see what happens if we
increased the size limit to 600 in timestep 1, left the size limit at
520 in timestep 2, and decreased the size limit to 450 in timestep 3.
Timestep 4 should match timestep 1, so should also be 600. Let’s say
we’re supposed to test the effects on the last three years’ final
preseason runs, which have run ids 28, 29, and 30. For reference, the
size limits are specified in the MinimumSize column of the SizeLimits
table.</p>
<p>We could specify those changes with the following match/replace
dataframe</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## make the match/replace dataframe for a single run</span></span>
<span><span class="va">mr_df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>match_FisheryID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">36</span>, <span class="fl">36</span>, <span class="fl">36</span><span class="op">)</span>, </span>
<span>                   match_TimeStep <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">4</span><span class="op">)</span>,</span>
<span>                   replace_MinimumSize <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">600</span>, <span class="fl">450</span>, <span class="fl">600</span><span class="op">)</span></span>
<span>                   <span class="op">)</span></span></code></pre></div>
<p>Before worrying about the run ids, our match/replace dataframe looks
like this:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mr_df</span></span></code></pre></div>
<pre><code><span><span class="co">##   match_FisheryID match_TimeStep replace_MinimumSize</span></span>
<span><span class="co">## 1              36              1                 600</span></span>
<span><span class="co">## 2              36              3                 450</span></span>
<span><span class="co">## 3              36              4                 600</span></span></code></pre>
<p>If we used this as it is, as in
<code>modify_table(fram_db, "SizeLimits", mr_df)</code>,
<code><a href="../reference/modify_table.html">modify_table()</a></code> would find all entries with fishery 36
timestep 1 or 4 and replace the MinimumSize with 600. Similarly, i
twould find all entries with fishery 36 timestep 3 and replace the
MinimumSize with 450. We can constrain these changes to run ids 28
through 30 by adding a <code>match_RunID</code> column</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mr_df</span> <span class="op">=</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand_grid.html" class="external-link">expand_grid</a></span><span class="op">(</span>match_RunID <span class="op">=</span> <span class="fl">28</span><span class="op">:</span><span class="fl">30</span>, <span class="va">mr_df</span><span class="op">)</span></span>
<span><span class="va">mr_df</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 9 × 4</span></span></span>
<span><span class="co">##   match_RunID match_FisheryID match_TimeStep replace_MinimumSize</span></span>
<span><span class="co">##         <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>               <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span>          28              36              1                 600</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span>          28              36              3                 450</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span>          28              36              4                 600</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span>          29              36              1                 600</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">5</span>          29              36              3                 450</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">6</span>          29              36              4                 600</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">7</span>          30              36              1                 600</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">8</span>          30              36              3                 450</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">9</span>          30              36              4                 600</span></span></code></pre>
<p>This framework allows us to specify any number of changes (to a
single table), with any kind of simple matching criterion. Further, it’s
easy to review the changes specified, and the changes can easily be
saved to a csv or excel file for later review.</p>
</div>
<div class="section level3">
<h3 id="scaling">Scaling<a class="anchor" aria-label="anchor" href="#scaling"></a>
</h3>
<p>We may not always want to specify our new values in absolute terms,
especially if we’re looking at the joint effects of changing several
values. The <code>calc_from_scaling()</code> allows the specification of
changes <em>relative to current values</em>, and returns the
corresponding match/replace table. For example, this allows us to
implement scenarios like “What if catch in these ten fisheries were 50%
of what we thought it was? What if it was 150% of what we thought it
was?. <code>calc_from_scaling()</code> takes the scenario using modified
version of the match/replace dataframe (with prefix”scale_” instead of
“replace_”), and runs the calculations to find what the actual
replacement values should be, then returns a match/replace dataframe
that can be fed into <code><a href="../reference/modify_table.html">modify_table()</a></code>. This is the framework
behind <code><a href="../reference/sensitivity_scaled.html">sensitivity_scaled()</a></code>.</p>
</div>
<div class="section level3">
<h3 id="sensitivity_-functions">sensitivity_*() functions<a class="anchor" aria-label="anchor" href="#sensitivity_-functions"></a>
</h3>
<p>As of writing, there are three functions designed to generate
sensitivity analyses</p>
<ul>
<li>
<code><a href="../reference/sensitivity_exact.html">sensitivity_exact()</a></code> takes a sequence of exact values to
be used in the sensitivity analyses. Useful for cases when we, for
example, want to look at what happens if a recruit scaler varies between
0.1 and 10.</li>
<li>
<code><a href="../reference/sensitivity_scaled.html">sensitivity_scaled()</a></code> takes a sequence of scaling
values. Useful if we want to look at concurrent changes for subsets of
stocks or fisheries in a way that is consistent with an existing run;
e.g. “what would have happened last year if all coastal stocks were 10%,
20%, …, 200% of the values used in the post-season run?</li>
<li>
<code><a href="../reference/sensitivity_custom.html">sensitivity_custom()</a></code> takes a list of match/replace
dataframes. This is harder to use, but supports more complex changes
like those needed to explore how changes in age composition affect ERs.
I would recommend writing additional functions to programmatically
generate those lists.</li>
</ul>
<p>Each of these functions starts with a template run in the FRAM
database, makes as many copies as necessary of that template run, makes
changes to each run so that they represent the spectrum of values needed
for the sensitivity analysis, and optionally copies a TAMM run into a
directory with appropriate naming so that the folder can be used to load
the runs and tamms into the FRAM multirun fork. By default these
functions also save the changes made and associated run ids into a log
file in the same directory as the FRAM database.</p>
<div class="section level4">
<h4 id="common-sensitivity-functions">Common sensitivity functions<a class="anchor" aria-label="anchor" href="#common-sensitivity-functions"></a>
</h4>
<p><code><a href="../reference/sensitivity_exact.html">sensitivity_exact()</a></code> and
<code><a href="../reference/sensitivity_scaled.html">sensitivity_scaled()</a></code> have similar arguments, most of them
exactly the same. For simplicity, I will not describe them all here;
instead, see their respective help pages. Each of these only allows
specification a single new value (either an exact value or a scaling
factor) for each sensitivity run, although it can be applied to multiple
columns and rows of a table. For example, it is possible to use
<code><a href="../reference/sensitivity_exact.html">sensitivity_exact()</a></code> to have the recruit scalers of a dozen
stocks be 0.1 in the first run, 0.2 in the second run, 0.3 in the third
run, etc. For something in which multiple values need to be changed but
not in concert, use <code><a href="../reference/sensitivity_custom.html">sensitivity_custom()</a></code>. (For complex
scenarios in which multiple values should be changing differently from
one another but proportionally to some starting ratio, it may be
possible to do so by first modifying the values of the template run to
the desired ratio and then using <code><a href="../reference/sensitivity_scaled.html">sensitivity_scaled()</a></code>).</p>
<p>When designing a sensitivity analysis, we need to first decide: -
what is our starting run? This determines <code>template_run</code>. -
What do we want to be changing across these runs? This determines
<code>table_name</code> and <code>match_df</code>. - What sequence of
values do we want to look at? This determines <code>scale_values</code>
or <code>exact_values</code>. Several notes here. First, because we
provide a vector of values, we can choose to a linear scale (e.g.,
<code>seq(0.1, 2, by = 0.1)</code>), OR we can choose a more complex
scale like a log scale(e.g.,
<code>exp(seq(log(10), log(100000), length = 50)))</code>. Second, the
length of the sequence of values we provide determines how many runs are
generated. In general it looks like we need to keep the number of runs
in FRAM access databases to no more than 500, so bear that in mind when
making sensitivity analyses. If there is a need for many more runs in a
single database, consider updating the FRAM fork to fold in the SQLite
support Ty wrote, and then modify these functions to work with SQLite as
well. - Do we want to use TAMMs with our sensitivity runs? If so, what
TAMM file do we want to be our template? Where do we want the
sensitivity run TAMMs to be saved? Using TAMM runs will slow the actual
sensitivity analyses run in FRAM, but are necessary to do things like
account for coastal iterations (Coho) or do a bunch of important things
(Chinook).</p>
</div>
<div class="section level4">
<h4 id="handling-complicated-things">Handling complicated things<a class="anchor" aria-label="anchor" href="#handling-complicated-things"></a>
</h4>
<p><code><a href="../reference/sensitivity_custom.html">sensitivity_custom()</a></code> allows the specification of
arbitrary scenarios for each sensitivity run; the only constraint is
that (currently) only one table can be changed for each sensitivity run.
If, in the future, we end up with frequent changes that must be
simultaneously specified across multiple tables, it may be useful to
change <code>sensitivity_custom</code> to optionally take a more complex
structure. Effectively we would want a list of lists for
<code>scenario_list</code>, but it would be safest if the “inner” list
(multiple match/replace tables to be applied to a single run) were
written as some kind of custom class / object-type so that there is less
space for mistakes.</p>
<p>We may sometimes want our sensitivity analysis to look at the effects
of changing the TAMM rather than values directly in FRAM. While there is
no direct method to do so, we can use <code><a href="../reference/sensitivity_scaled.html">sensitivity_scaled()</a></code>
as a quick way to create a series of identical runs and associated TAMMs
by providing <code>scale_values = rep(1, nrun)</code> where
<code>nrun</code> is the number of desired runs. We can then write code
to programmatically change the values in each TAMM. If this is a
frequent occurrence, we might write functions here or in {TAMMsupport}
to handle the TAMM modifications.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h2>
<p>As part of the Elwha Out of Base (OOB) work in 2025, we want to look
at how changes to the Elwha starting abundances affect ERs across the
board. I started by making a copy of the Elwa OOB “valid run” database
to ensure I had no way of accidentally screwing up the reference
database.</p>
<p><strong>Remainder of this section to be completed after
merging</strong></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Ty Garber, Collin Edwards.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
